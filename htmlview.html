<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval';">
  <title>Reset test page</title>
</head>
<body>
  <div class='container'>
    <div class='inputWrapper'>
      <label for='password1'>New Password:</label>
      <input id='password1' type="password" required />
    </div>
    <div class='inputWrapper'>
      <label for="password2">Enter Password:</label>
      <input id="password2" type="password" required />
    </div>
    <div>
      <button id="submit_btn">Submit</button>
    </div>
  </div>

  <script>
    alert('working')
    const button = document.getElementById('submit_btn')
    const password1 = document.getElementById('password1')
    const password2 = document.getElementById('password2')

    button.addEventListener('click', () => {
      const p1_value = password1.value
      const p2_value = password2.value
      if (p1_value && p2_value) {
        if (p1_value == p2_value) {
          const current_url_obj = new URL(window.location.href)
          let current_search_params = current_url_obj.search.replace('?', '').split('&')
          if (current_search_params.length == 2) {
            let current_search_params_obj = {}
            
            current_search_params.map(item => {
              let itemArray = item.split('=')
              let name = itemArray[0]
              let value = itemArray[1]
              current_search_params_obj[name] = value
              return {name: value} //does nothing with it
            })
            //current_search_params_obj now has uid and token. add password1 and password2

            current_search_params_obj['password1'] = p1_value
            current_search_params_obj['password2'] = p2_value

            //now create fetch request to send to confirmation backend
            console.log(current_search_params_obj)
            const confirmation_url = new URL('http://localhost:8000/users/password/reset/confirm/')
            fetch(confirmation_url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(current_search_params_obj)
            }).then(response => {
              if(!response.ok) throw new Error('Something went wrong')
              return response.json()
            }).then(data => {
              console.log(data)
              password1.value = ''
              password2.value = ''
              alert('rerouting to login page')
            }).catch(console.error)
          } else {
            alert('Unrecognised URL search argument present')
          }
        } else {
          alert('Passwords do not match')
        }
      }
    })
  </script>
</body>
</html>